var kmProtocolTypeEnum={KM_COMM_HTTP:"KMHttp",KM_COMM_HTTPS:"KMHttps",KM_COMM_WS:"KMWs",KM_COMM_WSS:"KMWss"};function KMTool(){}function KMCommunicationFactory(){this.typeMng=new Object}function KMCommunicationBase(e){var t=this;t.port=KMTool.getUrlPort(e),t.ipAddress=KMTool.getUrlIpAddress(e),t.reconnectCount=0,t.createWebSocket=function(){try{t.client=new WebSocket(t.newUrl),t.initEvevtHandle()}catch(e){t.reconnect(),console.log(e.message)}},t.initEvevtHandle=function(){t.client.onopen=function(){if(console.log("webSocket connect success!"),t.reconnectCount>0&&(t.reconnectCount=0),t.heartCheck(),window.sessionStorage.wsConnectState="true",t.needSendMess.length>0){for(var e=0;e<t.needSendMess.length;++e)t.client.send(t.needSendMess[e]);t.needSendMess.splice(0,t.needSendMess.length)}},t.client.onmessage=function(e){t.heartCheck(),"pang"!==e.data&&t.funcAddress(e)},t.client.onerror=function(){console.log("connect error!"),t.reconnect()},t.client.onclose=function(){"true"===window.sessionStorage.wsConnectState&&(window.sessionStorage.wsConnectState="false",t.reconnect())}},t.reconnect=function(){t.lockReconnect||t.reconnectCount>=5||(t.lockReconnect=!0,setTimeout(function(){t.createWebSocket(),t.lockReconnect=!1,t.reconnectCount++},t.reconnectTimeout))},t.sendMsg=function(e){t.client&&(1===t.client.readyState?t.client.send(e):t.needSendMess.push(e))},t.heartCheck=function(){t.heartReset(),t.heartStart()},t.heartStart=function(){t.forbidReconnect||(t.pingTimeoutId=setTimeout(function(){1===t.client.readyState?t.sendMsg(t.pingMsg):t.client.readyState,t.pangTimeoutId=setTimeout(function(){t.client.onclose()},t.pangTimeout)},t.pingTimeout))},t.heartReset=function(){clearTimeout(t.pingTimeoutId),clearTimeout(t.pangTimeoutId)},t.close=function(){t.client.close()},t.setOnmessage=function(e){t.funcAddress=e}}function KMCommunicationManager(){this.httpsServer=void 0}function KMHttp(e,t){KMCommunicationBase.call(this,e);this.init=function(){};var o=require("http");this.httpServer=o.createServer(t).listen(this.port,this.ipAddress)}function KMHttps(e,t,o){KMCommunicationBase.call(this,e);this.init=function(){};var n=require("https");this.httpServer=n.createServer(o,t).listen(this.port,this.ipAddress)}function KMWs(e,t,o){KMCommunicationBase.call(this,t);if(this.pingTimeout=15e3,this.pangTimeout=1e4,this.reconnectTimeout=2e3,this.pingMsg="ping",this.csType=e,this.url=t,this.funcAddress=o,this.needSendMess=new Array,this.client=null,this.server=null,this.url.slice(0,this.url.lastIndexOf(":"))===window.location.hostname)this.newUrl="ws://"+this.url;else{var n=this.url.slice(this.url.lastIndexOf(":"));this.newUrl="ws://"+window.location.hostname+n+"/"}this.createWebSocket()}function KMWss(e,t,o,n){KMCommunicationBase.call(this,t);this.pingTimeout=15e3,this.pangTimeout=1e4,this.reconnectTimeout=2e3,this.pingMsg="ping",this.csType=e,this.url=t,this.funcAddress=o,this.needSendMess=new Array,this.client=null,this.server=null,this.newUrl="wss://"+this.url,this.createWebSocket()}function KMFileRequest(){this.subcribers=[],this.checkStatusFlag=!1}KMTool.getUrlPort=function(e){var t=e.split(":");return parseInt(t[1])},KMTool.getUrlIpAddress=function(e){return e.split(":")[0]},KMCommunicationFactory.prototype.create=function(e,t,o,n,s){var r=this.typeMng[e];void 0==r&&(this.typeMng[e]=e,r=e);var a=void 0;switch(r){case kmProtocolTypeEnum.KM_COMM_HTTP:a=new KMHttp(o,n);break;case kmProtocolTypeEnum.KM_COMM_HTTPS:a=new KMHttps(o,n,s);break;case kmProtocolTypeEnum.KM_COMM_WS:a=new KMWs(t,o,n);break;case kmProtocolTypeEnum.KM_COMM_WSS:a=new KMWss(t,o,n)}return a},KMCommunicationManager.communicationManager=new KMCommunicationManager,KMCommunicationManager.getInstance=function(){if(void 0!=KMCommunicationManager.communicationManager)return KMCommunicationManager.communicationManager};var checkStatusFlag=!0;KMFileRequest.prototype.checkStatus=function(e){var t=this,o=arguments[1][0],n=arguments[1][1],s=arguments[1][2],r=arguments[1][3];new Promise(a=>{t.addSubscriber(()=>{a(e(o,n,s,r))})}),t.checkStatusFlag||(t.checkStatusFlag=!0,t.refreshTokenRequest(function(){t.checkStatusFlag&&(t.checkStatusFlag=!1,t.onAccessTokenFetched())}))},KMFileRequest.prototype.clockSubcsriber=function(e){var t=this,o=arguments[1][0],n=arguments[1][1],s=arguments[1][2],r=arguments[1][3];new Promise(a=>{t.addSubscriber(()=>{a(e(o,n,s,r))})})},KMFileRequest.prototype.refreshTokenRequest=function(e){$.ajax({url:encodeURI(urlType.WEBDATASERVER_URL+"/refreshToken"),dataType:"json",async:!1,type:"GET",jsonp:!1,headers:{refreshToken:window.sessionStorage.getItem("refreshToken"),token:getToken()},success:function(t,o){t&&"object"==typeof t&&(window.sessionStorage.setItem("refreshToken",t.refresh_token),window.sessionStorage.setItem("WellinUserToken",t.access_token),window.localStorage.refreshToken=t.refresh_token,window.localStorage.WellinUserToken=t.access_token),e()},complete:function(e){},error:function(e,t,o){}})},KMFileRequest.prototype.autoRefreshTokenRequest=function(e,t){$.ajax({url:encodeURI(urlType.WEBDATASERVER_URL+"/refreshToken"),dataType:"json",async:!1,type:"GET",jsonp:!1,headers:{refreshToken:window.sessionStorage.getItem("refreshToken"),token:e},success:function(e,o){e&&"object"==typeof e&&(window.sessionStorage.setItem("refreshToken",e.refresh_token),window.sessionStorage.setItem("WellinUserToken",e.access_token),window.localStorage.refreshToken=e.refresh_token,window.localStorage.WellinUserToken=e.access_token,e.created&&e.expired_in&&(window.sessionStorage.setItem("created",e.created),window.sessionStorage.setItem("expired_in",e.expired_in))),t(!0)},complete:function(e){},error:function(e,o,n){t(!1)}})},KMFileRequest.prototype.onAccessTokenFetched=function(){this.subcribers.forEach(e=>{e()}),this.subcribers=[]},KMFileRequest.prototype.addSubscriber=function(e){this.subcribers.push(e)},KMFileRequest.prototype.KMAjaxPost=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==o&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!0,data:o,type:"POST",headers:{Authorization:"Bearer "+getToken(),requesttime:a,projectname:encodeURI(window.sessionStorage.getItem("proName")),onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPost,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPost,r):n(e.responseText),n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxPost1=function(e,t,o,n){var s=this;if(console.log(o),console.log(o),void 0!==t&&void 0!==o&&void 0!==n){var r=parseInt((new Date).getTime())-parseInt(commDelay||0),a=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",contentType:"application/json",async:!0,data:o,type:"POST",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:r,onces:a},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t){console.log("success..."),console.log(e),n(e)},complete:function(e){var t=e.getResponseHeader("Redirect"),o=e.getResponseHeader("RedirectUrl");t&&o&&s.checkStatus(s.KMAjaxPostLoginSyn,argumentsPara),console.log(" complete...")},error:function(e,t,o){var r=e.getResponseHeader("Redirect"),a=e.getResponseHeader("RedirectUrl");r&&a&&s.checkStatus(s.KMAjaxPostLoginSyn,argumentsPara),n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxGetWorkFlow=function(e,t,o){var n=this,s=arguments;if(void 0!==t&&void 0!==o){parseInt((new Date).getTime()),parseInt(commDelay||0),kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!0,type:"GET",headers:{token:getToken()},beforeSend:function(){},success:function(e,t,r){var a=r.getResponseHeader("Redirect"),i=r.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGet,s):o(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,r){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGet,s):o(e.responseText)}})}},KMFileRequest.prototype.KMAjaxPostWorkFlow=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==o&&void 0!==n){parseInt((new Date).getTime()),parseInt(commDelay||0),kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!0,data:o,type:"POST",headers:{token:getToken()},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPost,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPostLoginSyn,r):n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxPostSyn=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==o&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!1,data:o,type:"POST",headers:{Authorization:"Bearer "+getToken(),requesttime:a,projectname:encodeURI(window.sessionStorage.getItem("proName")),onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPostLoginSyn,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxGet,r):n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxGet=function(e,t,o){var n=this,s=arguments;if(void 0!==t&&void 0!==o){var r=parseInt((new Date).getTime())-parseInt(commDelay||0),a=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!0,type:"GET",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:r,onces:a},beforeSend:function(){},success:function(e,t,r){var a=r.getResponseHeader("Redirect"),i=r.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGet,s):o(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,r){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGet,s):o(e.responseText)}})}},KMFileRequest.prototype.KMAjaxGetSyn=function(e,t,o){var n=this,s=arguments;if(void 0!==t&&void 0!==o){var r=parseInt((new Date).getTime())-parseInt(commDelay||0),a=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!1,type:"GET",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:r,onces:a},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,r){var a=r.getResponseHeader("Redirect"),i=r.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGetSyn,s):o(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,r){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGetSyn,s):o(e.responseText)}})}},KMFileRequest.prototype.KMDataAjaxGet=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",data:o,async:!0,type:"GET",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:a,onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMDataAjaxGet,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMDataAjaxGet,r):n(e.responseText)}})}},KMFileRequest.prototype.KMDataAjaxGetSyn=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",data:o,async:!1,type:"GET",traditional:!0,headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:a,onces:i},beforeSend:function(){},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMDataAjaxGetSyn,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var r=e.getResponseHeader("Redirect"),a=e.getResponseHeader("RedirectUrl");r&&a?s.checkStatus(s.KMDataAjaxGetSyn,arguments):n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxGetFileList=function(e,t,o){var n=this,s=arguments;if(void 0!==t&&void 0!==o){var r=parseInt((new Date).getTime())-parseInt(commDelay||0),a=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!0,type:"GET",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:r,onces:a},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,r){var a=r.getResponseHeader("Redirect"),i=r.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGetFileList,s):o(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,r){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?n.checkStatus(n.KMAjaxGetFileList,s):o(e.responseText)}})}},KMFileRequest.prototype.KMAjaxUploadFiles=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({data:o,url:t,type:"post",dataType:"JSON",contentType:!1,processData:!1,headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:a,onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxUploadFiles,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxUploadFiles,r):n(e.responseText)},xhr:function(){return myXhr=$.ajaxSettings.xhr(),myXhr.upload&&myXhr.upload.addEventListener("progress",function(s){var r=s.loaded,a=s.total,i=Math.floor(100*r/a)+"%";console.log("附件总大小 = "+r),console.log("已经上传大小 = "+a),console.log("已经上传百分比 = "+i);var c,d={progressFlag:!0};if(d.id=o.id,d.progress=i,d.total=a,-1!==(c=e.lastIndexOf("/")))var l=e.substring(c+1,e.length);else l=e;if(d.fileName=l,-1!==(c=t.lastIndexOf("/")))var p=t.substring(c+1,t.length);else p=t;d.upperFolder=p,n(d)},!1),myXhr}})}},KMFileRequest.prototype.KMAjaxUploadFilesSyn=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({data:o,url:t,type:"post",async:!1,dataType:"JSON",contentType:!1,processData:!1,headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:a,onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxUploadFiles,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxUploadFiles,r):n(e.responseText)},xhr:function(){return myXhr=$.ajaxSettings.xhr(),myXhr.upload&&myXhr.upload.addEventListener("progress",function(s){var r=s.loaded,a=s.total,i=Math.floor(100*r/a)+"%";console.log("附件总大小 = "+r),console.log("已经上传大小 = "+a),console.log("已经上传百分比 = "+i);var c,d={progressFlag:!0};if(d.id=o.id,d.progress=i,d.total=a,-1!==(c=e.lastIndexOf("/")))var l=e.substring(c+1,e.length);else l=e;if(d.fileName=l,-1!==(c=t.lastIndexOf("/")))var p=t.substring(c+1,t.length);else p=t;d.upperFolder=p,n(d)},!1),myXhr}})}},KMFileRequest.prototype.KMAjaxFileOperation=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({data:o,url:t,type:"post",dataType:"JSON",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:a,onces:i},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxFileOperation,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxFileOperation,r):n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxPostLoginSyn=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==o&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:t,dataType:"json",async:!1,data:o,type:"POST",headers:{Authorization:"Bearer "+getToken(),requesttime:a,onces:i,projectname:encodeURI(window.sessionStorage.getItem("proName"))},beforeSend:function(){console.log(e+" beforeSend...")},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPostLoginSyn,r):n(e)},complete:function(t){console.log(e+" complete...")},error:function(e,t,o){var r=e.getResponseHeader("Redirect"),a=e.getResponseHeader("RedirectUrl");r&&a?s.checkStatus(s.KMAjaxPostLoginSyn,arguments):n(e.responseText)}})}},KMFileRequest.prototype.postDataEncrypt=function(e){var t=e;return t=CryptoJS.AES.encrypt(e,"publickey"),t=decodeURIComponent(t)},KMFileRequest.prototype.KMAjaxPostSync=function(e,t,o,n){if(void 0!==t&&void 0!==o&&void 0!==n){var s=parseInt((new Date).getTime())-parseInt(commDelay||0),r=kmUlits.randomString(16);$.ajax({url:encodeURI(t),dataType:"json",async:!1,data:o,type:"POST",headers:{Authorization:"Bearer "+getToken(),projectname:encodeURI(window.sessionStorage.getItem("proName")),requesttime:s,onces:r},beforeSend:function(){console.log(e+" beforeSend...")},success:function(t,o){console.log(e+" success..."),n(t)},complete:function(t){var o=t.getResponseHeader("Redirect"),n=t.getResponseHeader("RedirectUrl");o&&n&&(window.location.href=n),console.log(e+" complete...")},error:function(e,t,o){e.getResponseHeader("Redirect"),e.getResponseHeader("RedirectUrl");n(e.responseText)}})}},KMFileRequest.prototype.KMAjaxPostParse=function(e,t,o,n){var s=this,r=arguments;if(void 0!==t&&void 0!==o&&void 0!==n){var a=parseInt((new Date).getTime())-parseInt(commDelay||0),i=kmUlits.randomString(16);$.ajax({url:t,dataType:"json",async:!0,data:o,type:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+getToken(),requesttime:a,projectname:encodeURI(window.sessionStorage.getItem("proName")),onces:i},success:function(e,t,o){var a=o.getResponseHeader("Redirect"),i=o.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPost,r):n(e)},error:function(e,t,o){var a=e.getResponseHeader("Redirect"),i=e.getResponseHeader("RedirectUrl");a&&i?s.checkStatus(s.KMAjaxPost,r):n(e.responseText)}})}};